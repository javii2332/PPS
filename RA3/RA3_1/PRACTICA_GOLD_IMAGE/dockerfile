# Heredamos de la P5 (Certificados + DoS + OWASP + ModSec)
FROM javi2332/pps_p5_javlluapa:latest

# 1. Crear usuario y grupo apache para ejecución sin privilegios
RUN groupadd apache && useradd -g apache apache

# 2. Configuración de Hardening de Protocolo y Servidor
# Aplicamos ServerTokens, Signature, ETag, Trace y Timeout
RUN echo "ServerTokens Prod" >> /etc/apache2/apache2.conf && \
    echo "ServerSignature Off" >> /etc/apache2/apache2.conf && \
    echo "FileETag None" >> /etc/apache2/apache2.conf && \
    echo "TraceEnable Off" >> /etc/apache2/apache2.conf && \
    echo "Timeout 60" >> /etc/apache2/apache2.conf

# 3. Deshabilitar listado de directorios y métodos HTTP peligrosos
# Aplicamos 'Options -Indexes' y limitamos métodos a nivel de servidor
RUN sed -i 's/Options Indexes FollowSymLinks/Options -Indexes +FollowSymLinks/' /etc/apache2/apache2.conf

# 4. Configuración de cabeceras adicionales (Clickjacking y XSS)
# El módulo headers ya está activo de la P5
RUN echo "Header always append X-Frame-Options SAMEORIGIN" >> /etc/apache2/apache2.conf && \
    echo "Header set X-XSS-Protection \"1; mode=block\"" >> /etc/apache2/apache2.conf && \
    echo "Header edit Set-Cookie ^(.*)$ \"\$1;HttpOnly;Secure\"" >> /etc/apache2/apache2.conf

# 5. Arreglar permisos para el usuario 'apache'
# Debe poder escribir en logs y leer la configuración
RUN chown -R apache:apache /var/log/apache2 /var/log/mod_evasive /var/www/html && \
    chmod -R 750 /etc/apache2/

# 6. Cambiar el usuario de ejecución en las variables de entorno de Apache
RUN sed -i 's/export APACHE_RUN_USER=.*/export APACHE_RUN_USER=apache/' /etc/apache2/envvars && \
    sed -i 's/export APACHE_RUN_GROUP=.*/export APACHE_RUN_GROUP=apache/' /etc/apache2/envvars

EXPOSE 80 443
CMD ["apache2ctl", "-D", "FOREGROUND"]
